# Setup and Deployment Guide

## Step 2: Database Migrations (Complete this now)

### Option A: Using EF Core Tools (Recommended)

1. **Install EF Core tools** (if not already installed):
   ```bash
   dotnet tool install --global dotnet-ef
   ```

2. **Create the initial migration**:
   ```bash
   cd Podcast.Api
   dotnet ef migrations add InitialCreate --project ../Podcast.Infrastructure
   ```

3. **Apply migrations to database**:
   ```bash
   dotnet ef database update --project ../Podcast.Infrastructure
   ```

### Option B: Using Package Manager Console (Visual Studio)

1. Open Package Manager Console
2. Set Default Project to `Podcast.Infrastructure`
3. Run:
   ```
   Add-Migration InitialCreate
   Update-Database
   ```

## Step 8: Deploy to MonsterASP.net

### Prerequisites
- GitHub repository with your code
- MonsterASP.net account
- SQL Server database on MonsterASP

### Deployment Steps

#### 1. Prepare Production Configuration

Update `appsettings.Production.json`:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "YOUR_MONSTERASP_SQL_CONNECTION_STRING"
  },
  "Jwt": {
    "Key": "YOUR_STRONG_SECRET_KEY_AT_LEAST_32_CHARACTERS",
    "Issuer": "PodcastApi",
    "Audience": "PodcastApi"
  },
  "Cors": {
    "AllowedOrigins": "https://yourdomain.com"
  }
}
```

**Important**: Never commit production secrets to Git! Use environment variables or MonsterASP's configuration panel.

#### 2. Configure GitHub Repository

1. Push your code to GitHub
2. Make sure `.gitignore` is working (excludes `appsettings.Production.json` if it contains secrets)

#### 3. Connect to MonsterASP.net

**Option A: GitHub Deploy (Recommended)**

1. Log into MonsterASP control panel
2. Navigate to "Deployments" or "Git Integration"
3. Connect your GitHub repository
4. Configure:
   - **Repository**: Your GitHub repo
   - **Branch**: `main` or `master`
   - **Build Command**: `dotnet build`
   - **Publish Path**: `Podcast.Api`
   - **Target Framework**: `net8.0`

**Option B: Manual Deploy**

1. Build the project locally:
   ```bash
   dotnet publish Podcast.Api -c Release -o ./publish
   ```
2. Upload the `publish` folder contents to MonsterASP via FTP

#### 4. Configure Database

1. In MonsterASP control panel, get your SQL Server connection string
2. Add it to environment variables or `appsettings.Production.json`
3. Run migrations on the server:
   - Option 1: SSH into server and run `dotnet ef database update`
   - Option 2: Use MonsterASP's database management tools
   - Option 3: Create a migration script and run it via SQL Server Management Studio

#### 5. Configure Environment Variables (Recommended)

In MonsterASP control panel, set these environment variables:
- `ASPNETCORE_ENVIRONMENT=Production`
- `ConnectionStrings__DefaultConnection=YOUR_CONNECTION_STRING`
- `Jwt__Key=YOUR_JWT_KEY`
- `Cors__AllowedOrigins=https://yourdomain.com`

#### 6. Configure IIS (if needed)

MonsterASP uses IIS. Ensure:
- Application pool is set to `.NET CLR Version: No Managed Code` (for .NET Core)
- Application pool identity has database access
- `web.config` is properly configured (auto-generated by .NET)

#### 7. Verify Deployment

1. Check health endpoint: `https://yourdomain.com/health`
2. Test Swagger: `https://yourdomain.com/swagger` (disable in production!)
3. Test API endpoints

#### 8. Post-Deployment Checklist

- [ ] Database migrations applied
- [ ] Connection string configured
- [ ] JWT key set (strong, random)
- [ ] CORS configured for your frontend domain
- [ ] Swagger disabled or protected
- [ ] Hangfire dashboard protected (add authorization)
- [ ] Logging configured
- [ ] Health checks working
- [ ] HTTPS enabled
- [ ] Environment variables set (not in code)

### Security Checklist for Production

1. **JWT Key**: Use a strong, randomly generated key (at least 32 characters)
   ```csharp
   // Generate a secure key:
   var key = Convert.ToBase64String(RandomNumberGenerator.GetBytes(32));
   ```

2. **Connection String**: Never commit to Git, use environment variables

3. **CORS**: Restrict to your frontend domain only

4. **Swagger**: Disable in production or add authentication:
   ```csharp
   // In Program.cs, modify:
   if (app.Environment.IsDevelopment())
   {
       app.UseSwagger();
       app.UseSwaggerUI();
   }
   ```

5. **Hangfire Dashboard**: Add proper authorization:
   ```csharp
   app.UseHangfireDashboard("/hangfire", new DashboardOptions
   {
       Authorization = new[] { new HangfireAuthorizationFilter() }
   });
   
   // Implement proper authorization in HangfireAuthorizationFilter
   ```

6. **HTTPS**: Ensure SSL certificate is configured

7. **Rate Limiting**: Configure rate limits for auth endpoints

### Troubleshooting

#### Database Connection Issues
- Verify connection string format
- Check SQL Server firewall rules
- Ensure database exists
- Verify credentials

#### Migration Issues
- Run migrations manually if auto-migration fails
- Check database permissions
- Verify connection string

#### Build Errors
- Check .NET 8 SDK is installed on server
- Verify all NuGet packages are restored
- Check for missing dependencies

#### Runtime Errors
- Check application logs
- Verify environment variables
- Check IIS application pool configuration
- Review Serilog log files

### Next Steps After Deployment

1. Test all API endpoints
2. Monitor application logs
3. Set up RSS sync jobs in Hangfire dashboard
4. Configure monitoring/alerting
5. Set up backups for database
6. Document API endpoints for frontend team

